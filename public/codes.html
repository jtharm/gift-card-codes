<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gift Card Codes</title>

<style>
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background: #f5f5f7;
    margin: 0;
    padding: 0;
  }

  .topbar {
    background: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .topbar span {
    font-size: 18px;
    font-weight: 600;
  }

  .logout-btn {
    padding: 10px 14px;
    background: #ff3b30;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    cursor: pointer;
  }

  .container {
    max-width: 500px;
    margin: 25px auto;
    background: white;
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    display: flex;
    flex-direction: column;
    gap: 20px;
  }

  h2 {
    text-align: center;
    margin-bottom: 10px;
  }

  label {
    display: block;
    margin: 8px 0;
    font-weight: 500;
  }

  input[type="text"], select {
    width: 100%;
    padding: 10px;
    margin-top: 4px;
    box-sizing: border-box;
    font-size: 1rem;
  }

  button.action-btn {
    width: 100%;
    padding: 14px;
    background: #007aff;
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 16px;
    cursor: pointer;
  }

  button.action-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  button.action-btn:active {
    background: #005fcc;
  }

  .section {
    border-radius: 12px;
    padding: 15px;
    background: #f9f9f9;
  }

  #codes-result, #retrieved-codes {
    font-size: 0.95rem;
    word-break: break-word;
    margin-top: 10px;
  }

  @media (max-width: 480px) {
    .container { margin: 15px; padding: 20px; }
    button.action-btn { font-size: 15px; padding: 12px; }
    input[type="text"], select { font-size: 0.95rem; padding: 8px; }
  }
</style>
</head>
<body>

<div class="topbar">
  <span id="userEmail">User</span>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="container">
  <h2>Gift Card Codes</h2>

  <!-- Mode selection -->
  <div class="section">
    <label><input type="radio" name="mode" value="purchase"> Purchase New Codes</label>
    <label><input type="radio" name="mode" value="retrieve"> Retrieve Previously Purchased Codes</label>
  </div>

  <div id="captcha-box" class="section" style="display:none; text-align:center;">
    <p id="captcha-question" style="font-weight:600;"></p>
    <div id="captcha-grid" style="
        display:grid;
        grid-template-columns: repeat(3, 60px);
        gap:10px;
        justify-content:center;
        margin-top:10px;
    "></div>
    <p id="captcha-error" style="color:red; display:none;">Try again.</p>
  </div>
  
  <!-- Purchase codes -->
  <div id="purchase-section" class="section" style="display:none;">
    <label><input type="radio" name="service" value="Uber"> Uber</label>
    <label><input type="radio" name="service" value="DoorDash"> DoorDash</label>

    <label>Quantity:
      <select id="quantity"></select>
    </label>

    <button class="action-btn" id="get-codes-btn" disabled>Get Codes</button>
    <div id="codes-result"></div>
  </div>

  <!-- Retrieve codes -->
  <div id="retrieve-section" class="section" style="display:none;">
    <label>Transaction ID:
      <input type="text" id="txn-id" placeholder="Enter transaction ID">
    </label>
    <button class="action-btn" id="retrieve-btn">Retrieve Codes</button>
    <div id="retrieved-codes"></div>
  </div>
</div>

<script>
let USER_EMAIL = null;
let currentMode = null;
let etransferEmail = null;
  
// Load user session info
async function loadUserEmail() {
  const res = await fetch("/session-info");
  if (!res.ok) return window.location = "/";
  const data = await res.json();
  USER_EMAIL = data.email;
  document.getElementById("userEmail").textContent = USER_EMAIL;
}

async function loadConfig() {
  const res = await fetch('/config');
  const cfg = await res.json();
  etransferEmail = cfg.etransferEmail;
}
  
// Run both BEFORE page logic
loadUserEmail();
loadConfig();

// Logout
async function logout() {
  await fetch("/logout", { method: "POST" });
  window.location.href = "/";
}

// Mode toggle
const modeRadios = document.querySelectorAll('input[name="mode"]');
const purchaseSection = document.getElementById("purchase-section");
const retrieveSection = document.getElementById("retrieve-section");

modeRadios.forEach(radio => {
  radio.addEventListener("change", () => {
    currentMode = radio.value;

    purchaseSection.style.display = currentMode === "purchase" ? "block" : "none";
    retrieveSection.style.display  = currentMode === "retrieve" ? "block" : "none";

    captchaSolved = false;
    generateCaptcha();
    updateButtonState();
  });
});

let captchaAnswer = null;
let captchaSolved = false;

function generateCaptcha() {
  captchaSolved = false;

  const emojis = ["üê±", "üê∂", "üöó", "üå≥", "üçé", "üçå", "üêº", "üéà", "‚≠ê"];
  const target = emojis[Math.floor(Math.random() * emojis.length)];

  captchaAnswer = target;

  const question = document.getElementById("captcha-question");
  const grid = document.getElementById("captcha-grid");
  const error = document.getElementById("captcha-error");

  error.style.display = "none";
  question.textContent = `Click all tiles containing: ${target}`;
  grid.innerHTML = "";

  let tiles = [];
  for (let i = 0; i < 9; i++) {
    let choice = emojis[Math.floor(Math.random() * emojis.length)];
    tiles.push(choice);
  }

  tiles.forEach((emoji, idx) => {
    const btn = document.createElement("button");
    btn.textContent = emoji;
    btn.style.fontSize = "32px";
    btn.style.padding = "10px";
    btn.style.borderRadius = "8px";
    btn.style.cursor = "pointer";
    btn.style.border = "1px solid #ccc";
    btn.style.background = "white";
    btn.dataset.correct = (emoji === target);

    btn.addEventListener("click", () => handleCaptchaClick(btn));
    grid.appendChild(btn);
  });

  document.getElementById("captcha-box").style.display = "block";
}

function handleCaptchaClick(button) {
  const error = document.getElementById("captcha-error");

  // If they click a wrong tile, CAPTCHA resets
  if (button.dataset.correct !== "true") {
    error.style.display = "block";
    generateCaptcha();
    updateButtonState();
    return;
  }

  // Mark correct tile as selected
  button.style.background = "#c8e6c9";
  button.disabled = true;

  // Check if all correct tiles are selected
  const remaining = [...document.querySelectorAll("#captcha-grid button")]
    .filter(btn => btn.dataset.correct === "true" && !btn.disabled);

  if (remaining.length === 0) {
    captchaSolved = true;
    updateButtonState();
  }
}

// Purchase codes
const getCodesBtn = document.getElementById("get-codes-btn");
const quantitySelect = document.getElementById("quantity");
const retrieveBtn = document.getElementById("retrieve-btn"); // add this if not already declared

// Listen for quantity changes
quantitySelect.addEventListener("change", updateButtonState);

document.getElementById("txn-id").addEventListener("input", updateButtonState);


function updateButtonState() {
  if (!captchaSolved) {
    getCodesBtn.disabled = true;
    retrieveBtn.disabled = true;
    return;
  }

  if (currentMode === "purchase") {
    getCodesBtn.disabled =
      !(selectedService && parseInt(quantitySelect.value, 10) > 0);
  }

  if (currentMode === "retrieve") {
    const txn = document.getElementById("txn-id").value.trim();
    retrieveBtn.disabled = txn.length === 0;
  }
}

let selectedService = null;

document.getElementsByName("service").forEach(r => {
  r.addEventListener("change", async () => {
    selectedService = r.value;
    getCodesBtn.disabled = true;
    quantitySelect.innerHTML = "";

    try {
      const res = await fetch(`/available?service=${selectedService}`);
      const data = await res.json();
      const available = data.available;
      const maxQty = Math.min(available, 4);

      for (let i = 1; i <= maxQty; i++) {
        const option = document.createElement("option");
        option.value = i;
        option.textContent = i;
        quantitySelect.appendChild(option);
      }

      generateCaptcha();

    } catch {
      getCodesBtn.disabled = true;
    }
  });
});

getCodesBtn.addEventListener("click", async () => {
  const qty = parseInt(quantitySelect.value, 10);
  const total = qty * 40;

  const ok = confirm(`Are you sure you want to purchase ${qty} ${selectedService} code(s) for $${total}?`);
  if (!ok) return; // user cancelled
  
  const div = document.getElementById("codes-result");
  div.textContent = "Processing...";
  try {
    const res = await fetch("/get-code", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ service: selectedService, quantity: qty })
    });
    const data = await res.json();
    if (data.error) {
      div.textContent = data.error;
      return;
    }

    div.innerHTML = `
      <p><strong>Transaction ID:</strong> ${data.txnId}</p>
      <p>Gift card codes have been sent from <a href="mailto:no-reply@test-nrw7gyme6xrg2k8e.mlsender.net">no-reply@test-nrw7gyme6xrg2k8e.mlsender.net</a> to ${USER_EMAIL}, may have gone into your junk mail folder.</p>
      <p><strong>Total due:</strong> $${data.total}</p>
      <p>Please make e-transfer payment to <a href="mailto:${etransferEmail}"><strong>${etransferEmail}</strong></a>.</p>
    `;
  } catch (err) {
    console.error(err);
    div.textContent = "Unknown error";
  }
});

// Retrieve codes
document.getElementById("retrieve-btn").addEventListener("click", async () => {
  const txnId = document.getElementById("txn-id").value.trim();
  const div = document.getElementById("retrieved-codes");
  div.innerHTML = "";

  if (!txnId) return alert("Please enter a transaction ID");

  div.textContent = "Loading...";
  try {
    const res = await fetch("/retrieve-codes", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ txnId })
    });
    const data = await res.json();

    if (!res.ok || data.error) {
      div.textContent = data.error || "Unknown error retrieving codes";
      return;
    }

    div.innerHTML = `
      <strong>Codes:</strong><br><br>
      ${data.codes.join("<br>")}
    `;
  } catch (err) {
    console.error(err);
    div.textContent = "Network error retrieving codes";
  }
});

// Show banner only when you're on the dev domain
if (location.hostname === "gift-card-codes-develop.onrender.com" || location.hostname === "gift-card-codes-develop.vercel.app") {
  const banner = document.createElement("div");
  banner.textContent = "‚ö†Ô∏è DEVELOPMENT VERSION ‚Äî For testing only";

  Object.assign(banner.style, {
    position: "fixed",
    top: "0",
    left: "0",
    width: "100%",
    background: "#ff0000",
    color: "#000",
    padding: "10px",
    fontSize: "15px",
    fontWeight: "bold",
    textAlign: "center",
    zIndex: "99999",
    borderBottom: "1px solid #000"
  });

  // Insert BEFORE your topbar
  const topbar = document.querySelector(".topbar");
  document.body.insertBefore(banner, topbar);

  // Move the topbar down (not entire body)
  topbar.style.marginTop = "45px";  // adjust if needed
}
</script>

</body>
</html>
